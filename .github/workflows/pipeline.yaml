name: Multi-Environment CI/CD Pipeline
 
on:
  push:
  branches: [main]
  paths:
    - 'apps/**'
    - 'environments/**'
    - '.github/workflows/**'
 
jobs:
  # Job 1: Desplegar a Dev (automÃ¡tico)
  deploy-dev:
  name: ğŸš€ Deploy a Dev
  if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  runs-on: self-hosted
  environment:
    name: dev
    url: http://dev.local
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to Dev
      run: |
        echo "ğŸš€ Desplegando en el entorno dev..."
        kubectl apply -k environments/dev
    
    - name: Wait for rollout
      run: |
        echo "â³ Esperando a que termine el despliegue..."
        kubectl rollout status deployment/dev-webapp -n dev --timeout=5m
    
    - name: Verify deployment
      run: |
        echo "âœ… Verificando el despliegue..."
        kubectl get pods -n dev -l app=webapp
        kubectl get svc -n dev
    
    - name: âœ… Dev deployment complete
      run: echo "âœ… Â¡Despliegue en dev finalizado!"
 
  # Job 2: Desplegar a Staging 
  deploy-staging:
  name: ğŸš€ Deploy a Staging
  needs: deploy-dev
  if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  runs-on: self-hosted
  environment:
    name: staging
    url: http://staging.local
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to Staging
      run: |
        echo "ğŸš€ Desplegando en el entorno staging..."
        kubectl apply -k environments/staging
    
    - name: Wait for rollout
      run: |
        echo "â³ Esperando a que termine el despliegue..."
        kubectl rollout status deployment/staging-webapp -n staging --timeout=5m
    
    - name: Verify staging deployment
      run: |
        echo "âœ… Verificando el despliegue..."
        kubectl get pods -n staging -l app=webapp
        kubectl get svc -n staging
    
    - name: âœ… Staging deployment complete
      run: echo "âœ… Â¡Despliegue en staging finalizado!"
 
  # Job 6: Desplegar a ProducciÃ³n (requiere aprobaciÃ³n manual)
  deploy-prod:
  name: ğŸš€ Deploy a ProducciÃ³n
  needs: deploy-staging
  if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  runs-on: self-hosted
  environment:
    name: production
    url: http://prod.local
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to Production
      run: |
        echo "ğŸš€ Desplegando en el entorno de producciÃ³n..."
        kubectl apply -k environments/prod
    
    - name: Wait for rollout
      run: |
        echo "â³ Esperando a que termine el despliegue..."
        kubectl rollout status deployment/prod-webapp -n prod --timeout=5m
    
    - name: Verify production deployment
      run: |
        echo "âœ… Verificando el despliegue..."
        kubectl get pods -n prod -l app=webapp
        kubectl get svc -n prod
    
    
    - name: âœ… Production deployment complete
      run: echo "âœ… Â¡Despliegue en producciÃ³n finalizado!"
